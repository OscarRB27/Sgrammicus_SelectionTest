---
title: "Getting inputs of environment variables"
author: "Óscar Romero Báez"
date: '2022-05-23'
output: html_document
---

This script is used to estimate the correlations that exist between the environmental variables of the sampling sites of my research project. Also, environmental variables will be standardized to homogenize the range of values.

Finally, the input files required to run BayPass are created. Go to the **Sgrammicus_Selection** folder to work.

### 1) Required libraries

```{r}
library(tidyverse)
library(ggplot2)
library(GGally)  
```

### 2) Required database is loaded

```{r}
#Enviromental variables database
Sg.env<-read.table("Data/Env_Data/Env_Data.txt",header=T)

#Explore data
str(Sg.env)
summary(Sg.env)
```
### 3) Correlations between variables
 
All sites

```{r}
#Calculate and plot correlations between variables
(Sg_corr_all<-ggpairs(Sg.env[,c(3:11)], #Variables selection
              aes(alpha = 0.5), #Transparency
              upper=list(continuous=wrap("cor",size=4)), #Size of correlation values
              lower=list(continuous="smooth",alpha = 0.3,size=0.1))+ #Add trend line
              theme_bw()) #Canvas definition
```

Save plot to pdf file

```{r}
ggsave("Analysis/Env_Vars/Figures/Sg_corr_all.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

Only two moderately high correlations were obtained, between NDVI-MSI and At-As. Following the **"rule of thumb"**, which indicates (Krehbiel, 2004):

- Coefficient between −0.3 and +0.3 = weak correlation. 
- Coefficient less than −0.7 or greater than +0.7 = strong correlation. 
- Coefficient between −0.3 and −0.7 or between +0.3 and +0.7 = moderate correlation.  

Therefore, no variable presented a strong correlation.

### 4) Standardization of variables

```{r}
#Standardization
Sg.std.env<-as.data.frame(scale(Sg.env[,c(3:11)],center=T,scale=T)) %>% round(digits=4)

#Creation of a new database with standardized values
Sg.std.env<-cbind(Sg.env[,c(1:2)],Sg.std.env)
```

### 5) Calculation of the mean of each variable by site

a) P5For site

```{r}
#Extraction of P5For samples
Vars_P5For<-filter(Sg.std.env,Site=="P5For")

#Means calculation of P5For samples
P5For.mean<-apply(Vars_P5For[,3:11],MARGIN=2,FUN=mean) %>% round(digits=4)
```

b) P5Agr site

```{r}
#Extraction of P5Agr samples
Vars_P5Agr<-filter(Sg.std.env,Site=="P5Agr") 

#Means calculation of P5Agr samples
P5Agr.mean<-apply(Vars_P5Agr[,3:11],MARGIN=2,FUN=mean) %>% round(digits=4)
```

c) P6For site

```{r}
#Extraction of P6For samples
Vars_P6For<-filter(Sg.std.env,Site=="P6For")

#Means calculation of P6For samples
P6For.mean<-apply(Vars_P6For[,3:11],MARGIN=2,FUN=mean) %>% round(digits=4)
```

d) P6Agr site

```{r}
#Extraction of P6Agr samples
Vars_P6Agr<-filter(Sg.std.env,Site=="P6Agr") 

#Means calculation of P6Agr samples
P6Agr.mean<-apply(Vars_P6Agr[,3:11],MARGIN=2,FUN=mean) %>% round(digits=4)
```

### 6) Combination of databases and creating environment variable inputs to run BayPass

6.1) Combination of all the database by site

```{r}
#Base with means
(Env_all<-as.data.frame(cbind(P5For.mean,P5Agr.mean,P6For.mean,P6Agr.mean)))
```

6.2) Combination and calculation of correlation between variables of P6 sites databases

```{r}
#Base with all variables values of P6 sites
Env_P6<-as.data.frame(rbind(Vars_P6For,Vars_P6Agr))

#Calculate and plot correlations between variables
(Sg_corr_P6<-ggpairs(Env_P6[,c(3:11)], #Variables selection
                     aes(alpha = 0.5), #Transparency
                     upper=list(continuous=wrap("cor",size=4)), #Size of correlation values
                     lower=list(continuous="smooth",alpha = 0.3,size=0.1))+ #Add trend line
                     theme_bw()) #Canvas definition
```

Save plot to pdf file

```{r}
ggsave("Analysis/Env_Vars/Figures/Sg_corr_P6.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

The correlations between P6 sites indicate that there was a strong correlation (>0.7) between the NDVI and MSI variables. Furthermore, there was a correlation close to 7 between NDVI and DEM. For that reason, NDVI was discarded for further analysis.

6.2.1) Creation of the input file for Baypass omitting the variable with strong correlation (NDVI) for P6 (Polynoge 6).

```{r}
#Base with means
Sg_Env_P6<-as.data.frame(cbind(P6For.mean,P6Agr.mean))

#Variables selection, skipping NDVI
(Sg_Env_P6<-Sg_Env_P6[c(1:8),])
```

6.3) Combination and calculation of correlation between variables of P5 site databases

```{r}
#Base with all variables values of P5 sites
Env_P5<-as.data.frame(rbind(Vars_P5For,Vars_P5Agr))

#Calculate and plot correlations between variables
(Sg_corr_P5<-ggpairs(Env_P5[,c(3:11)], #Variables selection
                     aes(alpha = 0.5), #Transparency
                     upper=list(continuous=wrap("cor",size=4)), #Size of correlation values
                     lower=list(continuous="smooth",alpha = 0.3,size=0.1))+ #Add trend line
                     theme_bw()) #Canvas definition
```

Save plot to pdf file

```{r}
ggsave("Analysis/Env_Vars/Figures/Sg_corr_P5.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

For the P5 sites, there were no correlations that were >0.7. However, it was decided to remove the At variable, which was close to 0.7 with St. In addition, it showed a greater number of significant correlations with other variables, although these were not > 0.7.

6.3.1) Creation of the input file for Baypass omitting the variables with strong correlation for P5 sites.

```{r}
#Base with means
Sg_Env_P5<-as.data.frame(cbind(P5For.mean,P5Agr.mean))

#Variables selection, skipping At
(Sg_Env_P5<-Sg_Env_P5[c(1,3:9),])
```

### 7) Save tables

a) All sites input

```{r}
write.table(Env_all,file="Data/BayPass/Input_Vars/Env_All.txt",row.names=F,col.names=F,quote=F,sep="\t")
```

b) P6 site input

```{r}
write.table(Sg_Env_P6,file="Data/BayPass/Input_Vars/Env_P6.txt",row.names=F,col.names=F,quote=F,sep="\t")
```

c) P5 site input

```{r}
write.table(Sg_Env_P5,file="Data/BayPass/Input_Vars/Env_P5.txt",row.names=F,col.names=F,quote=F,sep="\t")
```
