---
title: "BayeScan"
author: "Óscar Romero Báez"
date: '2022-05-21'
output: html_document
---

This analysis is part of my research project and this script will be used to analyze the results obtained from the BayeScan software from the SNP data obtained from four different sites where the *Sceloporus grammicus* lizard was sampled. For this proposal, the `plot_bayescan()` function that comes with the BayeScan software (Follows M and OE Gaggiotti, 2008) will be used to detect candidate loci under selection.

The format that BayeScan requires to run can be obtained using the PGDSpider program (Lischer HEL and Excoffier L, 2012). If you need to download both programs, go to the following links: http://cmpg.unibe.ch/software/BayeScan/download.html (BayeScan), http://www.cmpg.unibe.ch/software/PGDSpider/#Download_and_Installation_Instructions (PGDSpider).

Go to the **Sgrammicus_SelectionTest** folder to work with.

1) Run BayeScan

Parameters used to run BayeScan

Parameters All sites
`Analysis/BayeScan/Program/BayeScan2.1_macos64bits Data/BayeScan/Sg_All_Bayescan` 
`-o Analysis/BayeScan/Results/Sg_All/Sg_All_Bayescan_RE1 -threads 4 -n 5000 -thin 20 -nbp 20 -pilot 1000 -burn 10000`

2) Required libraries

```{r}
library(ggplot2)
```

3) Source to plot_bayescan() function that comes with BayeScan

```{r}
source("Analysis/BayeScan/Program/plot_R.r")
```

4) Load BayeScan output

```{r}
#Output of all sites
Sg.all<-read.table("Analysis/BayeScan/Results/Sg_All/Sg_All_Bayescan_RE1_fst.txt",  #File path
                  header=F, #Indicates that the variables in the file do not have names
                  sep="", #Type of data separation
                  col.names=c("bayescan_number","prob",
                              "log10(PO)","qval","alpha","fst")) #Put names to variables of file

#Loci info
Sg.loci<-read.table("Data/Loci_Info/Loci_info.txt",sep="\t",header=T)
```

5) Analysis and plotting of the output

```{r}
#All sites
#Analysis of all sites using plot_bayescan function
Sg.all.res<-plot_bayescan(Sg.all, #Data
                          FDR=0.01) #False discovery rate

#Review the number of outliers detected as candidates under selection
Sg.all.res$nb_outliers #Very large number!
```

6) False discovery rate correction

```{r}
#All sites
#Estimate the empirical cumulative distribution function (ECDF) for output
Likelihood_Function_A<-ecdf(Sg.all$alpha)
head(Likelihood_Function_A)
#Function evaluation for output
#Run function
Eval_A<-Likelihood_Function_A(Sg.all[,"alpha"]) 
#Check results
head(Eval_A)

#Calculate the p-value, as 1 - the values of the previous results
Likelihood_Pval_A<-1-Eval_A

#Since many comparisons are made, it is necessary to correct the p-values, which make with the function p.adjust
Likelihood_FDR_A<-p.adjust(Likelihood_Pval_A,"BH") #Correction method used, known as False Discovery Rate
```

7) Create a new data frame with the results that includes the original data and the adjusted p-values

```{r}
#All sites
#Copy original data
Sg.All.res<-Sg.all

#Add p-values
Sg.All.res$pval<-Likelihood_Pval_A
Sg.All.res$pval.adjust<-Likelihood_FDR_A
head(Sg.All.res)

#Examine which ones are significant now
(Sg.outliers.bs<-Sg.loci[Sg.All.res$pval.adjust<=0.001,])

#Export outliers database
write.table(Sg.outliers.bs,file="Analysis/BayeScan/Results/Sg_outliers/Sg.outliers.BS.txt",row.names=F,col.names=T,quote=F)
```

8) Explore significant outliers with a plot

```{r}
#All sites
(Sg.All.out<-ggplot(Sg.All.res,aes(x=fst,y=alpha))+ #Axis definition
                    geom_point(size=2,alpha=0.5, #Geometry definition
                    aes(colour=pval.adjust<=0.001))+ #Points color adjusted to p-val.adjust
                    scale_color_manual(values=c("black","red"))+ #Define point colors
                    theme_bw()+ #Canvas definition
                    ylab("Alpha")+ #y-lab name
                    xlab("Fst")+ #x-lab name
                    labs(color="Adjusted p-values")+ #Rename legend title
                    theme(axis.title.y=element_text(size=13), #y-axis title size
                    axis.title.x=element_text(size=13))+ #x-axis title size
                    annotate("text",x=0.57,y=0.43,label="L3203",size=3.5)) #Add candidate SNP name
```

Save plot to pdf file

```{r}
ggsave("Analysis/BayeScan/Figures/Sg.All.out.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```
