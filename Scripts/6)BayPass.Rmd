---
title: "BayPass"
author: "Óscar Romero Báez"
date: '2022-05-23'
output: html_document
---

This script is used to be able to observe the possible outliers after running the BayPass program. It is also useful to be able to establish an acceptance threshold that will help reduce false positives. This from creating simulation that are later compared with the real results. Finally, a script for a nice Manhattan plot is obtained to be able to visualize the results. This script is run using an analysis taking all the sites together. Remember that in order to run this and all the scripts you need to be in the **Sgrammicus_SelectionTest** folder.

# Load packages and source required to use ByPass functions

```{r}
library(ape)
library(ggcorrplot)
library(ggplot2)
source("Analysis/BayPass/Program/baypass_utils.R")
```

# Plot the correlation matrix based on the generated covariance matrix

```{r}
omega<-as.matrix(read.table("Analysis/BayPass/Results/BP_All/covis_mat_omega.out"))
pop.names<-c("P5For","P5Agr","P6For","P6Agr")
dimnames(omega)<-list(pop.names,pop.names)
#Compute and visualize the correlation matrix
cor.mat=cov2cor(omega)

#Loci info
Sg.loci<-read.table("Data/Loci_Info/Loci_info.txt",sep="\t",header=T)
```

# Compute and visualize the correlation matrix

```{r}
(Sg.BS.corr.all<-ggcorrplot(cor.mat ,#Matrix
                hc.order=TRUE, #Correlation matrix
                type="lower", #Data Representation
                outline.col="black", #Line color
                lab=T, #Show values of FST
                show.legend=TRUE, #Show legend
                title="Correlation map based on~hat(Omega)", #Title
                tl.cex=10, #Axis text size
                tl.srt=45, #Axis text angle
                ggtheme = ggplot2::theme_bw)+ #Canvas definition
                scale_fill_gradient2(low="red",high="blue",  #Choose the color from the color legend values
                                     breaks=c(-1,-0.50,0,0.50,1), #Define legend values
                                     limit=c(-1, 1))+ #Define the limits of the legend values
                labs(fill="Correlation"))
```
Save plot to pdf file

```{r}
ggsave("Analysis/BayPass/Figures/Sg.BS.corr.all.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

# Obtaining the likely candidates

```{r}
aux.snp.xtx=read.table("Analysis/BayPass/Results/BP_All/SN_covaux_summary_pi_xtx.out",h=T)$M_XtX
plot(aux.snp.xtx,xlab="SNP",ylab="XtX corrected for SMS")
```

# Generate simulations to calibrate the statistic and obtain the threshold
## Load the real data and the parameters obtained

```{r}
pi.beta.coef<-read.table("Analysis/BayPass/Results/BP_All/SN_covaux_summary_beta_params.out",h=T)$Mean
SN.data<-geno2YN("Data/BayPass/Input_Loci/SN_baypass_all.input")
```

# Create simulations simulations

```{r}
simu.bta<-simulate.baypass(omega.mat=omega,nsnp=7599,sample.size=SN.data$NN,
beta.pi=pi.beta.coef,pi.maf=0.05,remove.fixed.loci=TRUE,suffix="btapods")
```
#Create multiple *.btapods files

```{r}
#Cargamos los simulados
pod.xtx<-read.table("Analysis/BayPass/Results/BP_All/anapod_summary_pi_xtx.out",h=T)$M_XtX
#Usamos el 0.05 
pod.thresh=quantile(pod.xtx,probs=0.85)
#add the thresh to the actual XtX plot
plot(aux.snp.xtx,xlab="SNP",ylab="XtX corrected for SMS",cex=1)
abline(h=pod.thresh,lty=2,lwd=1.2,col="red")
```

# Extraction of true candidate SNPs

```{r}
Snps_XtX.all<-data.frame(XtX=aux.snp.xtx,pos=seq(1:length(aux.snp.xtx)),CHROM=Sg.loci$CHROM,ID=Sg.loci$ID)
outliers.baypass <-as.data.frame(Snps_XtX.all[Snps_XtX.all$XtX>=pod.thresh,])
```

# Export outliers
```{r}
write.table(outliers.baypass,file="Analysis/BayPass/Results/BP_All/outliers.baypass",row.names=F,col.names=T,quote=F)
```

# Prettier Manhattan-plot

```{r}
(Bs_plot_all<-ggplot(Snps_XtX.all,aes(x=pos,y=XtX))+ #Axis definition
             geom_point(size=0.75,colour="gray35")+ #Geometry definition
             geom_point(data=outliers.baypass,aes(x=pos,y=XtX,col="Outlier"))+ #Geometry definition
             xlab("Position")+theme_bw()+ #Canvas definition
             theme(legend.title=element_blank())) #Omit legend tittle
```

Save plot to pdf file

```{r}
ggsave("Analysis/BayPass/Figures/Bs_plot_all.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```
