---
title: "BayPass"
author: "Óscar Romero Báez"
date: '2022-05-23'
output: html_document
---


###Cargar datos de core

```{r}
library(ape)
library(ggcorrplot)
library(ggplot2)

source("Analysis/BayPass/Program/baypass_utils.R")
```

#Graficar la matriz de correlación basada en la matriz de  covarianza generada

```{r}
omega<-as.matrix(read.table("Analysis/BayPass/Results/BP_All/covis_mat_omega.out"))
pop.names<-c("P5For","P5Agr","P6For","P6Agr")
dimnames(omega)<-list(pop.names,pop.names)
#Compute and visualize the correlation matrix
cor.mat=cov2cor(omega)

#Loci info
Sg.loci<-read.table("Data/Loci_Info/Loci_info.txt",sep="\t",header=T)
```

#Compute and visualize the correlation matrix

```{r}
(Sg.BS.corr.all<-ggcorrplot(cor.mat ,#Matrix
                hc.order=TRUE, #Correlation matrix
                type="lower", #Data Representation
                outline.col="black", #Line color
                lab=T, #Show values of FST
                show.legend=TRUE, #Show legend
                title="Correlation map based on~hat(Omega)", #Title
                tl.cex=10, #Axis text size
                tl.srt=45, #Axis text angle
                ggtheme = ggplot2::theme_bw)+ #Canvas definition
                scale_fill_gradient2(low="red",high="blue",  #Choose the color from the color legend values
                                     breaks=c(-1,-0.50,0,0.50,1), #Define legend values
                                     limit=c(-1, 1))+ #Define the limits of the legend values
                labs(fill="Correlation"))
```
Save plot to pdf file

```{r}
ggsave("Analysis/BayPass/Figures/Sg.BS.corr.all.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

#Vamos a obtener los probables candidatos

```{r}
aux.snp.xtx=read.table("Analysis/BayPass/Results/BP_All/SN_covaux_summary_pi_xtx.out",h=T)$M_XtX
plot(aux.snp.xtx,xlab="SNP",ylab="XtX corrected for SMS")
```

###Generar simulaciones para calibrar el estadístico y obtener el threshold####
#Cargamos los los datos reales y los parámetros obtenidos

```{r}
pi.beta.coef<-read.table("Analysis/BayPass/Results/BP_All/SN_covaux_summary_beta_params.out",h=T)$Mean
SN.data<-geno2YN("Data/BayPass/Input_Loci/SN_baypass_all.input")
```

#Creamos las simulaciones

```{r}
simu.bta<-simulate.baypass(omega.mat=omega,nsnp=7599,sample.size=SN.data$NN,
beta.pi=pi.beta.coef,pi.maf=0.05,remove.fixed.loci=TRUE,suffix="btapods")
```
#Con esto se van a crear varios archivos *.btapods

```{r}
#Cargamos los simulados
pod.xtx<-read.table("Analysis/BayPass/Results/BP_All/anapod_summary_pi_xtx.out",h=T)$M_XtX
#Usamos el 0.05 
pod.thresh=quantile(pod.xtx,probs=0.85)
#add the thresh to the actual XtX plot
plot(aux.snp.xtx,xlab="SNP",ylab="XtX corrected for SMS",cex=1)
abline(h=pod.thresh,lty=2,lwd=1.2,col="red")
```

```{r}
##Extraemos los outliers
Snps_XtX.all<-data.frame(XtX=aux.snp.xtx,pos=seq(1:length(aux.snp.xtx)),CHROM=Sg.loci$CHROM,ID=Sg.loci$ID)
outliers.baypass <-as.data.frame(Snps_XtX.all[Snps_XtX.all$XtX>=pod.thresh,])
```

#Exportamos los outliers
```{r}
write.table(outliers.baypass,file="Analysis/BayPass/Results/BP_All/outliers.baypass",row.names=F,col.names=T,quote=F)
```

```{r}
#Podemos hacer un manhattan-plot
(Bs_plot_all<-ggplot(Snps_XtX.all,aes(x=pos,y=XtX))+
             geom_point(size=0.75,colour="gray35")+
             geom_point(data=outliers.baypass,aes(x=pos,y=XtX,col="Outlier"))+
             xlab("Position")+theme_bw()+
             theme(legend.title=element_blank()))#+
             #annotate("text",x=2250,y=5.4,label="L2651",size=3)+
             #annotate("text",x=5450,y=5.48,label="L5747",size=3)+
             #annotate("text",x=7250,y=5.4,label="L7511",size=3))
```

Save plot to pdf file

```{r}
ggsave("Analysis/BayPass/Figures/Bs_plot_all.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

P6 Sites

#Compute and visualize the correlation matrix

#Graficar la matriz de correlación basada en la matriz de  covarianza generada

```{r}
omega<-as.matrix(read.table("Analysis/BayPass/Results/BP_P6/covis_mat_omega.out"))
pop.names<-c("P6For","P6Agr")
dimnames(omega)<-list(pop.names,pop.names)
#Compute and visualize the correlation matrix
cor.mat=cov2cor(omega)

#Loci info
Sg.loci<-read.table("Data/Loci_Info/Loci_info.txt",sep="\t",header=T)
```



```{r}
(Sg.BS.corr.P6<-ggcorrplot(cor.mat ,#Matrix
                hc.order=TRUE, #Correlation matrix
                type="lower", #Data Representation
                outline.col="black", #Line color
                lab=T, #Show values of FST
                show.legend=TRUE, #Show legend
                title="Correlation map based on~hat(Omega)", #Title
                tl.cex=10, #Axis text size
                tl.srt=45, #Axis text angle
                ggtheme = ggplot2::theme_bw)+ #Canvas definition
                scale_fill_gradient2(low="red",high="blue",  #Choose the color from the color legend values
                                     breaks=c(-1,-0.50,0,0.50,1), #Define legend values
                                     limit=c(-1, 1))+ #Define the limits of the legend values
                labs(fill="Correlation"))
```

Save plot to pdf file

```{r}
ggsave("Analysis/BayPass/Figures/Sg.BS.corr.P6.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

#Vamos a obtener los probables candidatos

```{r}
aux.snp.xtx=read.table("Analysis/BayPass/Results/BP_P6/SN_covaux_summary_pi_xtx.out",h=T)$M_XtX
plot(aux.snp.xtx,xlab="SNP",ylab="XtX corrected for SMS")
```

###Generar simulaciones para calibrar el estadístico y obtener el threshold####
#Cargamos los los datos reales y los parámetros obtenidos

```{r}
pi.beta.coef<-read.table("Analysis/BayPass/Results/BP_P6/SN_covaux_summary_beta_params.out",h=T)$Mean
SN.data<-geno2YN("Data/BayPass/Input_Loci/SN_baypass_P6.input")
```

#Creamos las simulaciones

```{r}
simu.bta<-simulate.baypass(omega.mat=omega,nsnp=7599,sample.size=SN.data$NN,
beta.pi=pi.beta.coef,pi.maf=0.05,remove.fixed.loci=TRUE,suffix="btapods")
```
#Con esto se van a crear varios archivos *.btapods

```{r}
#Cargamos los simulados
pod.xtx<-read.table("Analysis/BayPass/Results/BP_P6/anapod_summary_pi_xtx.out",h=T)$M_XtX
#Usamos el 0.05 
pod.thresh=quantile(pod.xtx,probs=0.95)
#add the thresh to the actual XtX plot
plot(aux.snp.xtx,xlab="SNP",ylab="XtX corrected for SMS",cex=1)
abline(h=pod.thresh,lty=2,lwd=1.2,col="red")
```

```{r}
##Extraemos los outliers
Snps_XtX.all<-data.frame(XtX=aux.snp.xtx,pos=seq(1:length(aux.snp.xtx)),CHROM=Sg.loci$CHROM,ID=Sg.loci$ID)
outliers.baypass <-as.data.frame(Snps_XtX.all[Snps_XtX.all$XtX>=pod.thresh,])
```

#Exportamos los outliers
```{r}
write.table(outliers.baypass,file="Analysis/BayPass/Results/BP_P6/P6outliers.baypass",row.names=F,col.names=T,quote=F)
```

```{r}
#Podemos hacer un manhattan-plot
(Bs_plot_P6<-ggplot(Snps_XtX.all,aes(x=pos,y=XtX))+
             geom_point(size=0.75,colour="gray35")+
             geom_point(data=outliers.baypass,aes(x=pos,y=XtX,col="Outlier"))+
             xlab("Position")+theme_bw()+
             theme(legend.title=element_blank()))
```

Save plot to pdf file

```{r}
ggsave("Analysis/BayPass/Figures/Bs_plot_P6.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

P5 Sites

#Compute and visualize the correlation matrix

#Graficar la matriz de correlación basada en la matriz de  covarianza generada

```{r}
omega<-as.matrix(read.table("Analysis/BayPass/Results/BP_P5/covis_mat_omega.out"))
pop.names<-c("P5For","P5Agr")
dimnames(omega)<-list(pop.names,pop.names)
#Compute and visualize the correlation matrix
cor.mat=cov2cor(omega)

#Loci info
Sg.loci<-read.table("Data/Loci_Info/Loci_info.txt",sep="\t",header=T)
```



```{r}
(Sg.BS.corr.P5<-ggcorrplot(cor.mat ,#Matrix
                hc.order=TRUE, #Correlation matrix
                type="lower", #Data Representation
                outline.col="black", #Line color
                lab=T, #Show values of FST
                show.legend=TRUE, #Show legend
                title="Correlation map based on~hat(Omega)", #Title
                tl.cex=10, #Axis text size
                tl.srt=45, #Axis text angle
                ggtheme = ggplot2::theme_bw)+ #Canvas definition
                scale_fill_gradient2(low="red",high="blue",  #Choose the color from the color legend values
                                     breaks=c(-1,-0.50,0,0.50,1), #Define legend values
                                     limit=c(-1, 1))+ #Define the limits of the legend values
                labs(fill="Correlation"))
```

Save plot to pdf file

```{r}
ggsave("Analysis/BayPass/Figures/Sg.BS.corr.P5.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```

#Vamos a obtener los probables candidatos

```{r}
aux.snp.xtx=read.table("Analysis/BayPass/Results/BP_P5/SN_covaux_summary_pi_xtx.out",h=T)$M_XtX
plot(aux.snp.xtx,xlab="SNP",ylab="XtX corrected for SMS")
```

###Generar simulaciones para calibrar el estadístico y obtener el threshold####
#Cargamos los los datos reales y los parámetros obtenidos

```{r}
pi.beta.coef<-read.table("Analysis/BayPass/Results/BP_P5/SN_covaux_summary_beta_params.out",h=T)$Mean
SN.data<-geno2YN("Data/BayPass/Input_Loci/SN_baypass_P5.input")
```

#Creamos las simulaciones

```{r}
simu.bta<-simulate.baypass(omega.mat=omega,nsnp=7599,sample.size=SN.data$NN,
beta.pi=pi.beta.coef,pi.maf=0.05,remove.fixed.loci=TRUE,suffix="btapods")
```
#Con esto se van a crear varios archivos *.btapods

```{r}
#Cargamos los simulados
pod.xtx<-read.table("Analysis/BayPass/Results/BP_P5/anapod_summary_pi_xtx.out",h=T)$M_XtX
#Usamos el 0.05 
pod.thresh=quantile(pod.xtx,probs=0.90)
#add the thresh to the actual XtX plot
plot(aux.snp.xtx,xlab="SNP",ylab="XtX corrected for SMS",cex=1)
abline(h=pod.thresh,lty=2,lwd=1.2,col="red")
```


```{r}
##Extraemos los outliers
Snps_XtX.all<-data.frame(XtX=aux.snp.xtx,pos=seq(1:length(aux.snp.xtx)),CHROM=Sg.loci$CHROM,ID=Sg.loci$ID)
outliers.baypass <-as.data.frame(Snps_XtX.all[Snps_XtX.all$XtX>=pod.thresh,])
```

#Exportamos los outliers
```{r}
write.table(outliers.baypass,file="Analysis/BayPass/Results/BP_P5/P5outliers.baypass",row.names=F,col.names=T,quote=F)
```

```{r}
#Podemos hacer un manhattan-plot
(Bs_plot_P5<-ggplot(Snps_XtX.all,aes(x=pos,y=XtX))+
             geom_point(size=0.75,colour="gray35")+
             geom_point(data=outliers.baypass,aes(x=pos,y=XtX,col="Outlier"))+
             xlab("Position")+theme_bw()+
             theme(legend.title=element_blank()))
```

Save plot to pdf file

```{r}
ggsave("Analysis/BayPass/Figures/Bs_plot_P5.pdf",dpi=300,limitsize=TRUE,
       width=10,height=7)
```
